// отправка документа через робот в МАХ. РТ (Татарстан)
// кнопка отправки. Действие на клиенте. лексема send_doc_soglasie_PD
begin(objQr, obj, REQ, patID, phone, acID, qrPatAgree, patAgreeID, patAgree,patAgreeDate,
 p, po,  sectBD, sectMD,
    rso,headers,address,response,result,statusCode,status,error_text,url,json,json2,err)
{
    {CardLpu / OGRNCode},{CardLpu / InnCode},{CardLpu / KppCode},{CardLpu / EhrRusMdr308 / oid}
    ,{Patient / PatientID},{AmbulanceCardID}
}


    // @obj := {.};
            // запрос для теста на объекте
            @objQr := query {CardLpu / OGRNCode},{CardLpu / InnCode},{CardLpu / KppCode},{CardLpu / EhrRusMdr308 / oid}
                        ,{Patient / PatientID},{AmbulanceCardID}
                    from "AKUZ.AMBULANCE_CARD"
                    // where {AmbulanceCardID} = "7d5310da-6ed7-4360-bc0a-e0ce7d737480"; // Спасение 
                    where {AmbulanceCardID} ="3907befe-c0ba-4d56-9cb7-aaab990e2c68";
            @obj := @objQr[0]; 
  
    
    // подзапрос Номера телефона пациента. последний изменённый с типом "мобильный"
    @patID := @obj ->{Patient / PatientID};
    @phone := select top 1 {Number} from "AKUZ.PHONE_NUMBER"
                where {Patient / PatientID} = @patID
                    And {Number} <> Null()
                    And {PhoneType} = 3
                order by {AddedDate} desc;
    //@phone := "79625775703"; // телефон Всеволода
    //@phone := "79172367682"; // мой
    @phone := @phone[0][0];



    // ------------------ ЕСТЬ ЛИ УЖЕ ТАКОЕ СОГЛАСИЕ ------------------
    @acID := @obj -> {AmbulanceCardID};

    @qrPatAgree := query top 1 {FileID},{Status},{CreationDate} from "AKUZ.PATIENT_AGREE"
                    where {AmbulanceCard / AmbulanceCardID} = @acID
                       and {ObjectId} = "95966dd5-6ae1-4606-8d17-905b35a4f3a4" ; // "Согласие на обработку ПДн"
                       
    //$throw(Str(@acID));
    //$throw new ClientException(Str(@qrPatAgree -> Count()),"!!!");
    //if (@qrPatAgree -> Count() =0) //-------- ЕСЛИ НЕТ
    //---------- Создаём НОВОЕ "Согласие на обработку ПД" -----------
    begin(userQr)

        // 3907befe-c0ba-4d56-9cb7-aaab990e2c68 // моя АК в ГБ7
        //@acQr := query top 1 {AmbulanceCardID} from "AKUZ.AMBULANCE_CARD" where {AmbulanceCardID} = "3907befe-c0ba-4d56-9cb7-aaab990e2c68";
        @userQr := query top 1 {UserID} from "VCLib.BASE_USERS" where {UserID} = param(CURRENT_USER);

        @patAgree := new AKUZ.PATIENT_AGREE (new Apartment());
        @patAgree ->{AmbulanceCard} := @obj ;// *Object // AMB_CARD 
        @patAgree ->{CreationDate} := param(CURRENT_DATE_TIME); // Дата выдачи согласия
        @patAgree ->{ObjectId} := "95966dd5-6ae1-4606-8d17-905b35a4f3a4";  // Идентификатор документа, на которое выдано согласие 
        @patAgree ->{Name} := ""; // сперва пусто, потом название от бота ".zip"
        @patAgree ->{SaveFileLocation} = 1; // 1 - В базе данных
        @patAgree ->{BaseUsers} := @userQr[0]; //*Object // Пользователь, взявший согласие
        @patAgree ->{UseOle} := True;
        @patAgree ->{ObjectEntityId} := 1 ; // Сущность документа, на которое выдано согласие
        @patAgree ->{AgreeType} := 0; // Тип согласия, 0 - "Согласие"
        @patAgree ->{FileNameForm} := 1;
        @patAgree ->{Status} := 0; // 0 - Активно , 1 - Отозвано
        @patAgree-> Save();

        @patAgreeID :=@patAgree ->{FileID};
        //--------- ОТПРАВКА СООБЩЕНИЯ КЛИЕНТУ SendMessageClient 9b0f396d-9bf3-4116-9a03-7b612d9fd245
        begin(p, sessionID)
            @sessionID := param(USER_SESSION_ID);
            print(@sessionID);
            @p := new Process("SendMessageClient");
            @p->{Parameters}["Session"] := @sessionID;
            @p->{Parameters}["Caption"] := "Уведомление";
            @p->{Parameters}["Message"] := "Будет произведена отправка документа «Согласие на обработку персональных данных» с использованием системы «Госключ»"
            + Char(13) + "Убедитесь, что пациент в зарегистрирован в системах MAX и Госключ."
            + Char(13) + "(" + Str(@patAgreeID) +")";
            @p->Run()[@p];
        end;
    end;

    // 381485




    
    ///---------------------------- ОТПРАВКА ЗАПРОСА с СЕРВЕРА ----------------------------
    // @p := new Process("send_doc_soglasie_PD_Proccess",@obj);
    // @p->{Parameters}["patAgreeID"] := @patAgreeID;
    // @p->{Parameters}["phone"] := @phone;
    // @po := @p -> Run();

    ////////////   СЕРВЕРНАЯ ЧАСТЬ   ////////////

 

    //-------------  СОЗДАНИЕ СТРУКТУРЫ СУЩНОСТЕЙ  -------------//
    declare MAX.BUSINESS_DATA(
        ogrnExecutor:string,
        innExecutor:string,
        kppExecutor:string
    );

    declare MAX.MEDICAL_DATA(
        innExecutor:string,
        kppExecutor:string
    );

    declare MAX.SEND_DOCUMENTS(
        patAgreeID: string,
        //dealTypes:MAX.DEAL_TYPE[parent],
        dealTypes: string,
        businessData: MAX.BUSINESS_DATA,
        medicalData: MAX.MEDICAL_DATA,
        departmentId: string,
        departmentOID: string,
        phoneNumber: string

    );

    // ------------- структура тела ответа в JSON -------------
    // успешный запрос/ответ:
    // {
    //   "transactionId": "da84baea-7d61-4f18-a05f-976dfeee15f3"
    // }
    // ели у них ошибка:
    // {
    //   "StateCode": 400,
    //   "ErrorDescription": "{\"error\":\"USER_NOT_FOUND\"}\n"
    // }

    declare MAX.DOCS_SERV_RESPONSE(
        transactionId: strinig, 

        StateCode: int,             // 400,
        ErrorDescription: string    // "{\"error\":\"USER_NOT_FOUND\"}\n"
    );


    // @obj :=  @process->{Object};
    // @patAgreeID := @process->{Parameters}["patAgreeID"];
    // @phone := @process->{Parameters}["phone"];


    //---------- ЗАПОЛНЕНИЕ СТРУКТУРЫ ЗАПРОСА --------------
    @REQ := new MAX.SEND_DOCUMENTS();
    @REQ -> {patAgreeID} := @patAgreeID;
    @REQ -> {dealTypes} := "95966dd5-6ae1-4606-8d17-905b35a4f3a4"; // = Согласие на обработку ПД 
        @sectBD := new MAX.BUSINESS_DATA();
        @sectBD -> {ogrnExecutor}:= @obj->{CardLpu / OGRNCode};
        @sectBD -> {innExecutor}:= @obj->{CardLpu / InnCode};
        @sectBD -> {kppExecutor}:= @obj->{CardLpu / KppCode};
    @REQ -> {businessData} := @sectBD;
        @sectMD := new MAX.MEDICAL_DATA();
    @REQ -> {medicalData} := @sectMD;
    @REQ -> {departmentId}:= "b661d2dd-bfe1-4ec9-970f-89167695cd7c";
    @REQ -> {departmentOID}:= @obj->{CardLpu / EhrRusMdr308 / oid};
    //@REQ -> {phoneNumber} := @phone;//Replace(Replace(Replace(Replace(@phone,"+","")"()","")")","")"-","");//"79625775703";
    @REQ -> {phoneNumber} := Replace(Replace(Replace(Replace(Str(@phone),"+",""),"(",""),")",""),"-","");

    @json := Replace(Replace(Str(@REQ,"Json"),"\"flags_\":\"1\",",""),"\"flags_\":\"1\"","") ;
    //$throw new ClientException(@json,"Тело запроса");
    print(@json);




    @headers:= new Hashtable();
    @headers["Authorization"] := "Basic 0JDQtNC80LjQvdC40YHRgtGA0LDRgtC+0YA6";
    @headers["Content-Type"]:="application/json; charset=utf-8";

    // @address:="http://10.224.24.55/max_prod_gk/hs/sign_documents/sendDocumetns"; // с сервера
    @address:="http://10.224.105.150:3000/max_prod_gk/hs/sign_documents/sendDocumetns"; // с клиента
    
    //$throw(Str(@json));


    @rso:=new AKUZ.RABBIT_SEND_OBJECT(new Apartment());
    @rso -> {QueueName}:=@patAgreeID;
    @rso -> {Content}:=Str(@json);
    @rso -> {RoutingKey}:="";
    @rso -> {Type}:= "MAX_SEND_DOC_REQUEST";
    @rso -> {State}:=1;
    @rso -> {ContentEncoding}:="utf-8";
    @rso -> {CreateDateTime}:= param(CURRENT_DATE_TIME);
    @rso -> Save();


    // --------------------- ОТПРАВКА ЗАПРОСА ---------------------

    // try
    // begin()
        @response := $Send POST Request to @address with headers @headers data @REQ {patAgreeID}
            ,{dealTypes}
            ,{businessData / ogrnExecutor}
            ,{businessData / innExecutor}
            ,{businessData / innExecutor}
            ,{departmentId}
            ,{departmentOID}
            ,{phoneNumber}
        ;

        //@result:=$Expect unsafe "MAX.DOCS_SERV_RESPONSE" From @response inbody as json;
        //////////////////////////////////////////////////////////////////////////
            // ПРИМЕР посадить ответ в текст
            @result:=$Expect unsafe "string" From @response inbody;
            @json2:=@result["Response"]->{Body};	

        
        @statusCode:= @result["Response"]->{StatusCode}; // 200 - Работает
        //@json2 := Replace(Replace(str(@result["Body"],"Json"),"\"flags_\":\"1\",",""),"\"flags_\":\"1\"","") ;


    @rso:=new AKUZ.RABBIT_SEND_OBJECT(new Apartment());
    @rso -> {QueueName}:=@patAgreeID;
    @rso -> {Content}:=@json2;
    @rso -> {RoutingKey}:=@statusCode;
    @rso -> {Type}:="MAX_SEND_DOC_RESPONSE";
    @rso -> {State}:=1;
    @rso -> {ContentEncoding}:="utf-8";
    @rso -> {CreateDateTime}:= param(CURRENT_DATE_TIME);
    @rso -> Save();

    
    // @json2 :=  "{\"StateCode\":400,\"ErrorDescription\":\"Тело отправляемого запроса не имеет phoneNumber\"}";
    if(@json2 Like "%transactionId%")
        @status := True;
        //@transactionId:= @result["Body"]->{transactionId};

    if(@json2 Like "%ErrorDescription%")
        @error_text:= @json2;
        //@error_text:= @result["Body"]->{ErrorDescription};



    print(@error_text);



    // end
    // catch(ex)
    // begin()
    //     // @err := @ex->{InnerException};
    //     // while (RegExMatch("--> ", @err, "All")->Count()-1 >0 )
    //     //     @err := SubString(@err,IndexOf(@err,"--> ")+4,StringLen(@err));

    //     // @HospExamsList->{error} := SubString(@err,IndexOf(@err,":")+2,IndexOf(@err,Char(13))-IndexOf(@err,":")-2 );

    //     // @response.StatusCode := 500;
    //     // return(@HospExamsList);
    //     @json2 := Str( @ex -> {InnerException});
    //     @err :=  @ex -> {Message};
    //     //------------  Отправка сообщения
    //     // @p := new Process("SendMessageClient");
    //     // @p->{Parameters}["Session"] := param(USER_SESSION_ID);
    //     // @p->{Parameters}["Caption"] := "Ошибка";
    //     // @p->{Parameters}["Message"] := @err;
    //     // @p-> Run();
    // end;
    // $throw new ClientException(@json2,"!!!!!");

end;